var $url="/write/editor",$urlUpdate=$url+"/actions/update",$urlPreview=$url+"/actions/preview",data=utils.init({pageType:null,siteId:utils.getQueryInt("siteId"),channelId:utils.getQueryInt("channelId"),contentId:utils.getQueryInt("contentId"),page:utils.getQueryInt("page"),tabName:utils.getQueryString("tabName"),mainHeight:"",sideType:"first",collapseSettings:["checkedLevel","addDate"],isSettings:!0,site:null,siteUrl:null,channel:null,groupNames:null,tagNames:null,checkedLevels:null,siteOptions:null,channelOptions:null,styles:null,form:null,isPreviewSaving:!1}),methods={runFormLayerImageUploadText:function(t,e,i){this.insertText(t,e,i)},runFormLayerImageUploadEditor:function(t,e){this.insertEditor(t,e)},runMaterialLayerImageSelect:function(t,e,i){this.insertText(t,e,i)},runFormLayerFileUpload:function(t,e,i){this.insertText(t,e,i)},runMaterialLayerFileSelect:function(t,e,i){this.insertText(t,e,i)},runFormLayerVideoUpload:function(t,e,i){this.insertText(t,e,i)},runMaterialLayerVideoSelect:function(t,e,i){this.insertText(t,e,i)},runEditorLayerImage:function(t,e){this.insertEditor(t,e)},insertText:function(t,e,i){(this.form[utils.getCountName(t)]||0)<=e&&(this.form[utils.getCountName(t)]=e),this.form[utils.getExtendName(t,e)]=i,this.form=_.assign({},this.form)},insertEditor:function(t,e){t||(t="Body"),e&&utils.getEditor(t).execCommand("insertHTML",e)},updateGroups:function(t,e){this.groupNames=t.groupNames,utils.success(e)},apiGet:function(){var t=this;window.onresize=t.winResize,window.onresize(),$api.get($url,{params:{siteId:t.siteId,channelId:t.channelId,contentId:t.contentId}}).then(function(e){var i=e.data;if(i.unauthorized)return t.pageType="Unauthorized",void utils.loading(t,!1);t.site=i.site,t.siteUrl=i.siteUrl,t.channel=i.channel,t.groupNames=i.groupNames,t.tagNames=i.tagNames,t.checkedLevels=i.checkedLevels,t.siteOptions=i.siteOptions,t.channelOptions=i.channelOptions,t.styles=i.styles,t.form=_.assign({},i.content),0===t.form.id&&(t.form.checkedLevel=-99),(t.form.top||t.form.recommend||t.form.hot||t.form.color)&&t.collapseSettings.push("attributes"),t.form.groupNames&&t.form.groupNames.length>0?t.collapseSettings.push("groupNames"):t.form.groupNames=[],t.form.tagNames&&t.form.tagNames.length>0?t.collapseSettings.push("tagNames"):t.form.tagNames=[],t.form.linkUrl&&t.collapseSettings.push("linkUrl");for(var n=0;n<t.styles.length;n++){var s=t.styles[n];if("CheckBox"===s.inputType||"SelectMultiple"===s.inputType){var a=t.form[utils.toCamelCase(s.attributeName)];Array.isArray(a)||(t.form[utils.toCamelCase(s.attributeName)]=a?utils.toArray(a):[])}else"Image"===s.inputType||"File"===s.inputType||"Video"===s.inputType?t.form[utils.getCountName(s.attributeName)]=utils.toInt(t.form[utils.getCountName(s.attributeName)]):"Text"!==s.inputType&&"TextArea"!==s.inputType&&"TextEditor"!==s.inputType||0===t.contentId&&(t.form[utils.toCamelCase(s.attributeName)]=s.defaultValue)}setTimeout(function(){for(var e=0;e<t.styles.length;e++){var i=t.styles[e];if("TextEditor"===i.inputType){var n=utils.getEditor(i.attributeName);n.styleIndex=e,n.ready(function(){this.addListener("contentChange",function(){var e=t.styles[this.styleIndex];t.form[utils.toCamelCase(e.attributeName)]=this.getContent()})})}}},100)}).catch(function(t){utils.error(t)}).then(function(){utils.loading(t,!1)})},apiInsert:function(){var t=this;utils.loading(this,!0),$api.post($url,{siteId:this.siteId,channelId:this.channelId,contentId:this.contentId,content:this.form}).then(function(e){e.data;t.closeAndRedirect()}).catch(function(t){utils.error(t)}).then(function(){utils.loading(t,!1)})},apiUpdate:function(){var t=this;utils.loading(this,!0),$api.post($urlUpdate,{siteId:this.siteId,channelId:this.channelId,contentId:this.contentId,content:this.form}).then(function(e){e.data;t.closeAndRedirect()}).catch(function(t){utils.error(t)}).then(function(){utils.loading(t,!1)})},closeAndRedirect:function(t){var e=utils.getTabVue(this.tabName);e&&(utils.success("内容保存成功！"),e.apiList(this.page)),utils.removeTab(),utils.openTab(this.tabName)},winResize:function(){this.mainHeight=$(window).height()-70+"px"},btnLayerClick:function(t){var e={siteId:this.siteId,channelId:this.channelId};t.attributeName&&(e.attributeName=t.attributeName),t.contentId&&(e.contentId=t.contentId),t.no&&(e.no=t.no),utils.openLayer({title:t.title,url:utils.getCommonUrl(t.name,e),full:t.full,width:t.width?t.width:700,height:t.height?t.height:500})},btnSaveClick:function(){UE&&$.each(UE.instants,function(t,e){e.sync()}),0===this.contentId?this.apiInsert():this.apiUpdate()},btnPreviewClick:function(){if(this.styles[0].value&&!this.isPreviewSaving){UE&&$.each(UE.instants,function(t,e){e.sync()});var t=this;utils.loading(this,!0),$api.post($urlPreview,{siteId:this.siteId,channelId:this.channelId,contentId:this.contentId,content:this.form}).then(function(e){var i=e.data;t.isPreviewSaving=!1,window.open(i.url)}).catch(function(t){utils.error(t)}).then(function(){utils.loading(t,!1)})}},btnCloseClick:function(){utils.removeTab()},btnExtendAddClick:function(t){var e=this.form[utils.getCountName(t.attributeName)]+1;this.form[utils.getCountName(t.attributeName)]=e,this.form[utils.getExtendName(t.attributeName,e)]="",this.form=_.assign({},this.form)},btnExtendRemoveClick:function(t){var e=this.form[utils.getCountName(t.attributeName)];this.form[utils.getCountName(t.attributeName)]=e-1,this.form[utils.getExtendName(t.attributeName,e)]="",this.form=_.assign({},this.form)},btnExtendPreviewClick:function(t,e){for(var i=this.form[utils.getCountName(t)],n=[],s=0;s<=i;s++){var a=this.form[utils.getExtendName(t,s)];a=utils.getUrl(this.siteUrl,a),n.push({src:a})}layer.photos({photos:{start:e,data:n},anim:5})}},$vue=new Vue({el:"#main",data:data,methods:methods,created:function(){this.apiGet()}});